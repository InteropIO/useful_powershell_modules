function Get-M365DefenderMachineVulnerability {
    <#
    .SYNOPSIS
    Retrieves a list of all the vulnerabilities affecting the organization per machine and software.

    .DESCRIPTION
    Retrieves a list of all the vulnerabilities affecting the organization per machine and software.

    .PARAMETER header
    Header created using New-M365DefenderAuthHeader.

    .PARAMETER severity
    Filter vulnerabilities by severity.

    Possible values: 'Low', 'Medium', 'High', 'Critical'

    .PARAMETER apiUrl
    API url.

    By default "api-eu.securitycenter.microsoft.com" for best performance in EU region.

    .EXAMPLE
    $header = New-M365DefenderAuthHeader

    $allMachineVulnerabilities = Get-M365DefenderMachineVulnerability -header $header

    .NOTES
    Requires Vulnerability.Read.All permission.

    https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/api/get-all-vulnerabilities-by-machines?view=o365-worldwide
    #>

    [CmdletBinding()]
    param (
        $header,

        [ValidateSet('Low', 'Medium', 'High', 'Critical', ignorecase = $False)]
        [string[]] $severity,

        [ValidateSet("api.securitycenter.microsoft.com", "api-eu.securitycenter.microsoft.com", "api-us.securitycenter.microsoft.com", "api-uk.securitycenter.microsoft.com", "api-au.securitycenter.microsoft.com")]
        [string] $apiUrl = "api-eu.securitycenter.microsoft.com"
    )

    if (!$header) {
        $header = New-M365DefenderAuthHeader -ErrorAction Stop
    }

    $url = "https://$apiUrl/api/vulnerabilities/machinesVulnerabilities"

    if ($severity) {
        $sevF = ""
        $severity | % {
            if ($sevF) { $sevF = $sevF + " or " }

            $sevF += "severity eq '$_'"
        }
        $url = $url + "?`$filter=($sevF)"
    }

    Invoke-RestMethod2 -Uri $url -Headers $header
}